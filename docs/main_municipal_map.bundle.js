(()=>{"use strict";const e={"boundary-tiles":{type:"vector",url:"https://tiles.dvrpc.org/data/census_boundaries.json"},"sidewalk-tiles":{type:"vector",url:"https://tiles.dvrpc.org/data/pedestrian-network.json"},"mcpcv1-tiles":{type:"vector",url:"https://tiles.dvrpc.org/data/sidewalk-prioritiesv3.json"}},t=(e,t)=>{var i;(i=new XMLHttpRequest).open("GET","https://omad-api-lf2k9.ondigitalocean.app/sidewalk/all-munis",!0),i.setRequestHeader("Access-Control-Allow-Origin","*"),i.onload=function(){if(this.status>=200&&this.status<400){var i=JSON.parse(this.response);e.addSource("all-munis",{type:"geojson",data:i}),e.addLayer({id:"all-municipalities",type:"line",source:"all-munis",paint:{"line-color":"black","line-opacity":.5}},t)}},i.send(),(i=new XMLHttpRequest).open("GET","https://omad-api-lf2k9.ondigitalocean.app/sidewalk/one-muni/?q=Abington%20Township",!0),i.setRequestHeader("Access-Control-Allow-Origin","*"),i.onload=function(){if(this.status>=200&&this.status<400){var i=JSON.parse(this.response);e.addSource("one-muni",{type:"geojson",data:i}),e.addLayer({id:"selected-municipality",type:"line",source:"one-muni",paint:{"line-color":"red","line-opacity":0,"line-width":10}},t)}},i.send(),(i=new XMLHttpRequest).open("GET","https://omad-api-lf2k9.ondigitalocean.app/sidewalk/pois-near-gap/?q=60943",!0),i.setRequestHeader("Access-Control-Allow-Origin","*"),i.onload=function(){if(this.status>=200&&this.status<400){var i=JSON.parse(this.response);e.addSource("selected_poi_data",{type:"geojson",data:i}),e.addLayer({id:"selected_pois",type:"circle",source:"selected_poi_data",paint:{"circle-radius":10,"circle-opacity":0,"circle-stroke-opacity":0,"circle-stroke-color":"black","circle-stroke-width":1,"circle-color":{property:"ab_ratio",default:"black",stops:[[0,"rgba(0, 0, 0, 1)"],[1e-4,"rgba(255, 0, 0, 1)"],[.1,"rgba(255, 153, 0, 1)"],[.5,"rgba(255, 255, 0, 1)"],[1,"rgba(0, 153, 0, 1)"]]}}},t)}},i.send()},i=(e,t)=>{let i="https://omad-api-lf2k9.ondigitalocean.app/sidewalk/one-muni/?q="+t.replace(" ","%20"),o="https://omad-api-lf2k9.ondigitalocean.app/sidewalk/gaps-within-muni/?q="+t.replace(" ","%20");var s;console.log(i),(s=new XMLHttpRequest).open("GET",i,!0),s.setRequestHeader("Access-Control-Allow-Origin","*"),s.onload=function(){if(this.status>=200&&this.status<400){var t=JSON.parse(this.response);e.getSource("one-muni").setData(t),e.setPaintProperty("selected-municipality","line-opacity",.5)}},s.send(),(s=new XMLHttpRequest).open("GET",o,!0),s.setRequestHeader("Access-Control-Allow-Origin","*"),s.onload=function(){if(this.status>=200&&this.status<400){var t=JSON.parse(this.response);console.log(t);var i=["in","uid"].concat(t);e.setFilter("gaps",i),e.setPaintProperty("gaps","line-opacity",.5)}},s.send()},o=(e,t,i,o,a)=>{console.log(t),console.log(i);let n="https://omad-api-lf2k9.ondigitalocean.app/sidewalk/gaps-near-xy/?lng="+i+"&lat="+t;var l=new XMLHttpRequest;l.open("GET",n,!0),l.setRequestHeader("Access-Control-Allow-Origin","*"),l.onload=function(){if(this.status>=200&&this.status<400){var n=JSON.parse(this.response),l=["in","uid"].concat(n);e.setFilter("gaps",l),e.setPaintProperty("gaps","line-opacity",.5),s(e,o,[i,t],a)}},l.send()},s=(e,t,i,o)=>{var s=["in","uid",t];e.setFilter("clicked_gap",s),e.setPaintProperty("clicked_gap","line-opacity",1),e.flyTo({center:i,zoom:15,essential:!0});var a=document.getElementById("stat-island");a.innerHTML=o<1?"add to the sidewalk network where none currently exists":1==o?'extend the coverage of  <span class="green-text" style="font-weight: bold">one</span> existing island':'connect <span class="green-text" style="font-weight: bold">'+o+"</span> existing sidewalk islands";let n="https://omad-api-lf2k9.ondigitalocean.app/sidewalk/pois-near-gap/?q="+t.toString();var l=new XMLHttpRequest;l.open("GET",n,!0),l.setRequestHeader("Access-Control-Allow-Origin","*"),l.onload=function(){if(this.status>=200&&this.status<400){var t=JSON.parse(this.response),i=Object.keys(t.features).length;e.getSource("selected_poi_data").setData(t),e.setPaintProperty("selected_pois","circle-stroke-opacity",1),e.setPaintProperty("selected_pois","circle-opacity",1),document.getElementById("stat-destinations").innerHTML='improve pedestrian connectivity to <span class="green-text" style="font-weight: bold">'+i+"</span> destinations"}},l.send(),document.getElementById("stat-box").style.setProperty("visibility","visible")},a=e=>{e.on("click","all_pois",(function(e){var t=e.features[0].properties,i=e.lngLat.lat,o=e.lngLat.lng;let s=((a=window.location.href.split("/")).pop(),a.join("/")+"/by-destination.html?lat="+i+"&lng="+o+"&id="+t.poi_uid+"&name="+t.poi_name.replace(" ","_")+"&ab_ratio="+t.ab_ratio.toString());var a;console.log(s),window.location.href=s}))},n=(e,t,i)=>{new mapboxgl.Popup({closeButton:!1,className:"i-am-a-popup"}).setLngLat(i.lngLat).setHTML(t).addTo(e)},l=()=>{var e=document.getElementsByClassName("mapboxgl-popup");e.length&&e[0].remove()},r=e=>{["gaps","all_pois"].forEach((t=>((e,t)=>{e.on("mouseenter",t,(()=>e.getCanvas().style.cursor="pointer")),e.on("mouseleave",t,(function(t){e.getCanvas().style.cursor=""}))})(e,t))),e.on("mouseenter","gaps",(function(t){n(e,"<h3>Click this gap to learn more</h3>",t)})),e.on("mouseleave","gaps",(function(e){l()})),e.on("mouseenter","all_pois",(function(t){var i=t.features[0].properties,o="<div style='text-align: center;'><h3 class='green-text'>"+(e=>{try{var t=e.split(" ").map((e=>e[0].toUpperCase()+e.substr(1).toLowerCase())).join(" ")}catch{t=e}return t})(i.poi_name)+"</h3>";o+="<p>"+(e=>{var t=100*e;if(t>100&&(t=100),100==t)var i="100%";else i=0==t?"No":t<0?"Only":String(t.toFixed(1))+"%";return i})(i.ab_ratio)+" sidewalk coverage</p><p class='italic' style='font-size:80%'>Click this point to jump to the destination map</p></div>",n(e,o,t)})),e.on("mouseleave","all_pois",(function(e){l()}))};mapboxgl.accessToken="pk.eyJ1IjoiYWFyb25kdnJwYyIsImEiOiJja2NvN2s5dnAwaWR2MnptbzFwYmd2czVvIn0.Fcc34gzGME_zHR5q4RnSOg";const c={montco:{id:"montco",type:"line",source:"boundary-tiles","source-layer":"county",layout:{},paint:{"line-width":10,"line-opacity":.4,"line-color":"black"},filter:["==","CNTY_NAME","Montgomery County"]}},p={sw:{id:"sw",type:"line",source:"sidewalk-tiles","source-layer":"ped_lines",paint:{"line-width":4,"line-opacity":.2,"line-color":"black"},layout:{visibility:"visible"},filter:["all",["==","line_type",1],["==","county","MONTGOMERY"]]},xwalk:{id:"xwalk",type:"line",source:"sidewalk-tiles","source-layer":"ped_lines",paint:{"line-width":9,"line-opacity":.2,"line-color":"black"},layout:{visibility:"visible"},filter:["all",["==","line_type",2],["==","county","MONTGOMERY"]]},clicked_gap:{id:"clicked_gap",type:"line",source:"mcpcv1-tiles","source-layer":"montco_missing_sidewalks",paint:{"line-color":"yellow","line-opacity":0,"line-width":{property:"island_count",default:100,stops:[[0,3],[1,10],[2,20]]}},layout:{visibility:"visible"}},gaps:{id:"gaps",type:"line",source:"mcpcv1-tiles","source-layer":"montco_missing_sidewalks",paint:{"line-color":"rgb(57,83,164)","line-opacity":0,"line-width":{property:"island_count",default:100,stops:[[0,1],[1,5],[2,10]]}},layout:{visibility:"visible"}},all_pois:{id:"all_pois",type:"circle",source:"mcpcv1-tiles","source-layer":"pois_centroids",layout:{},paint:{"circle-radius":3,"circle-opacity":.6,"circle-stroke-opacity":.6,"circle-stroke-color":"white","circle-stroke-width":1,"circle-color":"black"}}},d={sidewalks:{id:"sw",attribute:"line-width",style:["interpolate",["exponential",.5],["zoom"],10,.01,17,3]},crosswalks:{id:"xwalk",attribute:"line-width",style:["interpolate",["exponential",.5],["zoom"],10,.05,18,6]}},u=e=>{var t=document.getElementById("dropdown_muni"),o=document.getElementById("subtitle");t.addEventListener("change",(function(){var s=t.value;o.innerHTML=s,i(e,s),document.getElementById("stat-box").style.setProperty("visibility","hidden");let a="https://omad-api-lf2k9.ondigitalocean.app/sidewalk/one-muni-centroid/?q="+s.replace(" ","%20");var n=new XMLHttpRequest;n.open("GET",a,!0),n.setRequestHeader("Access-Control-Allow-Origin","*"),n.onload=function(){if(this.status>=200&&this.status<400){var t=JSON.parse(this.response);console.log(t),e.flyTo({center:[t[0].x,t[0].y],zoom:13,essential:!0})}},n.send(),e.setPaintProperty("clicked_gap","line-opacity",0),e.setPaintProperty("selected_pois","circle-opacity",0),e.setPaintProperty("selected_pois","circle-stroke-opacity",0)}))},y=new mapboxgl.Map({container:"map",style:"mapbox://styles/aarondvrpc/ckqhcmx6x95x318pgqzt4jicq",center:[-75.36277290123333,40.20129661107534],zoom:10});y.on("load",(function(){for(const t in e)y.addSource(t,e[t]);for(const e in c)y.addLayer(c[e],"road-label");t(y,"road-label");for(const e in p)y.addLayer(p[e],"road-label");for(const e in d)y.setPaintProperty(d[e].id,d[e].attribute,d[e].style);(e=>{e.on("click","gaps",(function(t){var i=t.features[0].properties;console.log(i),s(e,i.uid,t.lngLat,i.island_count)}))})(y),a(y),r(y),u(y);let i=(()=>{let e=new URLSearchParams(window.location).get("search");if(""==e)return null;{let t={};return e.split("&").forEach((e=>{let i=(e=e.replace("?","")).split("=");t[i[0]]=i[1]})),t}})();i&&(console.log(i),o(y,i.lat,i.lng,parseInt(i.id),i.island_count))}))})();